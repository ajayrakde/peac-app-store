name: Deploy Medusa to Azure Container Apps

on:
  workflow_dispatch: {}

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Medusa Deployment

    env:
      RESOURCE_GROUP: ${{ vars.RG_NAME }}
      ACR_NAME: ${{ vars.ACR_NAME }}
      ENVIRONMENT_NAME: ${{ vars.ENV_NAME }}
      REGISTRY_SERVER: ${{ vars.ACR_NAME }}.azurecr.io
      IMAGE_TAG: medusa:${{ github.sha }}
      IMAGE_URI: ${{ vars.ACR_NAME }}.azurecr.io/medusa:${{ github.sha }}

      STORE_CORS: "http://localhost:3000"
      ADMIN_CORS: "http://localhost:7000"
      AUTH_CORS: "http://localhost:3000,http://localhost:7000"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Generate and store JWT_SECRET and COOKIE_SECRET in Key Vault if missing
        shell: bash
        env:
          RESOURCE_GROUP: ${{ env.RESOURCE_GROUP }}
          KEY_VAULT_NAME: kv-kanhaa-app-store  # Adjust as needed
        run: |
          if ! az keyvault secret show --vault-name $KEY_VAULT_NAME --name JWT-SECRET &> /dev/null; then
            JWT_SECRET=$(openssl rand -hex 32)
            az keyvault secret set --vault-name $KEY_VAULT_NAME --name JWT-SECRET --value "$JWT_SECRET"
          fi
          if ! az keyvault secret show --vault-name $KEY_VAULT_NAME --name COOKIE-SECRET &> /dev/null; then
            COOKIE_SECRET=$(openssl rand -hex 32)
            az keyvault secret set --vault-name $KEY_VAULT_NAME --name COOKIE-SECRET --value "$COOKIE_SECRET"
          fi

      - name: Deploy medusa-server
        uses: azure/container-apps-deploy-action@v1
        with:
          acrName: ${{ env.ACR_NAME }}
          resourceGroup: ${{ env.RESOURCE_GROUP }}
          containerAppName: medusa-server
          containerAppEnvironment: ${{ env.ENVIRONMENT_NAME }}
          registryUrl: ${{ env.REGISTRY_SERVER }}
          imageToDeploy: ${{ env.IMAGE_URI }}
          yamlConfigPath: ./configs/medusa-config.yaml
          environmentVariables: |
            - name: MEDUSA_WORKER_MODE
              value: "server"
            - name: DISABLE_MEDUSA_ADMIN
              value: "false"

      - name: Deploy medusa-worker
        uses: azure/container-apps-deploy-action@v1
        with:
          acrName: ${{ env.ACR_NAME }}
          resourceGroup: ${{ env.RESOURCE_GROUP }}
          containerAppName: medusa-worker
          containerAppEnvironment: ${{ env.ENVIRONMENT_NAME }}
          registryUrl: ${{ env.REGISTRY_SERVER }}
          imageToDeploy: ${{ env.IMAGE_URI }}
          yamlConfigPath: ./configs/medusa-config.yaml
          environmentVariables: |
            - name: MEDUSA_WORKER_MODE
              value: "worker"
            - name: DISABLE_MEDUSA_ADMIN
              value: "true"
